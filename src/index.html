<!DOCTYPE html>
<head>
  <title>
    縦書き鏡文字ジェネレーター | 映画『かがみの孤城』応援プロジェクト
    #かがみの孤城
  </title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
    crossorigin="anonymous"
  />
  <style type="text/css">
    canvas {
      border: 1px solid #888;
    }
  </style>
  <meta
    property="og:url"
    content="https://ftnext.github.io/flipped-letters-generator/"
  />
  <meta property="og:type" content="website" />
  <meta
    property="og:title"
    content="縦書き鏡文字ジェネレーター | 映画『かがみの孤城』応援プロジェクト #かがみの孤城"
  />
</head>
<body>
  <h1>縦書き鏡文字ジェネレーター</h1>
  <div>
    <input id="sentenceInput" value="かがみの孤城はいいぞ" />
  </div>
  <hr />
  <div>
    <canvas id="canvas" width="200" height="400"></canvas>
  </div>
  <hr />
  <div>
    <button id="copyButton" class="btn btn-outline-secondary">クリップボードにコピー</button>
    <br />
    <br />
    <button id="downloadButton" class="btn btn-outline-success">ダウンロード</button>
    <br />
    <br />
    <a role="button" id="twitterLink" class="btn btn-primary btn-lg" target="_blank" rel="noopener noreferrer">
      鏡文字をTweetする
    </a>
  </div>

  <script>
    function initializeWithParameters(inputElement) {
      const initialParams = new URLSearchParams(location.search);
      const initialSentence = initialParams.get("sentenceInput");
      if (initialSentence) inputElement.value = initialSentence;

      if (location.search) history.replaceState({}, document.title, "");
    }

    const sentenceInput = document.getElementById("sentenceInput");
    initializeWithParameters(sentenceInput);

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    function clearCanvas() {
      ctx.fillStyle = "white";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function calculateXCenterLeftBottomInMirror(canvasWidth, charHeight) {
      const centerX = canvasWidth / 2;
      const startXRightBottom = centerX + charHeight / 2;
      const mirrorStartXBottom = -startXRightBottom;
      return mirrorStartXBottom;
    }

    function calculateYCenterLeftBottom(
      canvasHeight,
      sentenceHeight,
      charHeight
    ) {
      const upperBlankHeight = (canvasHeight - sentenceHeight) / 2;
      return upperBlankHeight + charHeight;
    }

    function fillTextVertically(
      ctx,
      text,
      startXLeftBottom,
      startYLeftBottom,
      charHeight
    ) {
      [...text].forEach((char, i) => {
        const charStartYLeftBottom = startYLeftBottom + charHeight * i;
        ctx.fillText(char, startXLeftBottom, charStartYLeftBottom);
      });
    }

    function drawTextInMirror(ctx, text, fontSize) {
      ctx.scale(-1, 1);

      drawText(ctx, text, fontSize);

      ctx.scale(-1, 1);
    }

    function drawText(ctx, text, fontSize) {
      ctx.font = `${fontSize}px serif`;
      ctx.fillStyle = "#666";

      const charHeight = ctx.measureText("あ").width;
      const textWidth = ctx.measureText(text).width;

      const startXLeftBottom = calculateXCenterLeftBottomInMirror(
        canvas.width,
        charHeight
      );
      const startYLeftBottom = calculateYCenterLeftBottom(
        canvas.height,
        textWidth,
        charHeight
      );

      fillTextVertically(
        ctx,
        text,
        startXLeftBottom,
        startYLeftBottom,
        charHeight
      );
    }

    function buildGeneratorQueryParams(text) {
      const generatorParams = new URLSearchParams();
      generatorParams.append("sentenceInput", text);
      return generatorParams;
    }

    function buildTwitterIntentParams(text) {
      const tweetParams = new URLSearchParams();
      const generatorParams = buildGeneratorQueryParams(text);
      tweetParams.append(
        "url",
        `https://ftnext.github.io/flipped-letters-generator/?${generatorParams}`
      );
      tweetParams.append(
        "text",
        `[保存した画像またはクリップボードにコピーした画像を貼り付けてください]「${text}」を鏡文字にしました！`
      );
      tweetParams.append("hashtags", "かがみの孤城");
      return tweetParams;
    }

    function setupTweetLink(text) {
      const tweetParams = buildTwitterIntentParams(text);
      const twitterLink = document.querySelector("#twitterLink");
      if (twitterLink)
        twitterLink.href = `https://twitter.com/intent/tweet?${tweetParams}`;
    }

    function updateCanvas() {
      clearCanvas();

      const sentence = sentenceInput.value;
      const fontSize = 40;

      drawTextInMirror(ctx, sentence, fontSize);
      setupTweetLink(sentence);
    }

    sentenceInput.addEventListener("input", updateCanvas);

    document
      .querySelector("#copyButton")
      ?.addEventListener("click", (event) => {
        canvas.toBlob((blob) => {
          if (!blob) return;
          const item = new ClipboardItem({ "image/png": blob });
          navigator.clipboard.write([item]).then(() => {
            if (!event.target) return;
            const target = event.target;
            const original = target.innerHTML;
            target.innerHTML = "コピーされました";
            window.setTimeout(() => {
              target.innerHTML = original;
            }, 850);
          });
        });
      });

    document.querySelector("#downloadButton")?.addEventListener("click", () => {
      const link = document.createElement("a");
      link.download = `flipped_letters_${Date.now()}.png`;
      link.href = canvas.toDataURL();
      link.click();
    });

    updateCanvas();
  </script>
</body>
