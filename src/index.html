<!DOCTYPE html>
<head>
  <title>
    縦書き鏡文字ジェネレーター | 映画『かがみの孤城』応援プロジェクト
    #かがみの孤城
  </title>
  <style type="text/css">
    canvas {
      border: 1px solid #888;
    }
  </style>
  <meta
    property="og:url"
    content="https://ftnext.github.io/flipped-letters-generator/"
  />
  <meta property="og:type" content="website" />
  <meta
    property="og:title"
    content="縦書き鏡文字ジェネレーター | 映画『かがみの孤城』応援プロジェクト #かがみの孤城"
  />
</head>
<body>
  <div>
    <input id="sentenceInput" />
    <button id="drawCanvas">鏡文字にする</button>
  </div>
  <hr />
  <div>
    <canvas id="canvas" width="200" height="400"></canvas>
  </div>
  <hr />
  <div>
    <a id="twitterLink" target="_blank" rel="noopener noreferrer">
      鏡文字をTweetする
    </a>
  </div>

  <script>
    const sentenceInput = document.getElementById("sentenceInput");
    const drawButton = document.getElementById("drawCanvas");

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    function clearCanvas() {
      ctx.fillStyle = "white";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function calculateXCenterLeftBottomInMirror(canvasWidth, charHeight) {
      const centerX = canvasWidth / 2;
      const startXRightBottom = centerX + charHeight / 2;
      const mirrorStartXBottom = -startXRightBottom;
      return mirrorStartXBottom;
    }

    function calculateYCenterLeftBottom(
      canvasHeight,
      sentenceHeight,
      charHeight
    ) {
      const upperBlankHeight = (canvasHeight - sentenceHeight) / 2;
      return upperBlankHeight + charHeight;
    }

    function fillTextVertically(
      ctx,
      text,
      startXLeftBottom,
      startYLeftBottom,
      charHeight
    ) {
      [...text].forEach((char, i) => {
        const charStartYLeftBottom = startYLeftBottom + charHeight * i;
        ctx.fillText(char, startXLeftBottom, charStartYLeftBottom);
      });
    }

    function drawTextInMirror(ctx, text, fontSize) {
      ctx.scale(-1, 1);

      drawText(ctx, text, fontSize);

      ctx.scale(-1, 1);
    }

    function drawText(ctx, text, fontSize) {
      ctx.font = `${fontSize}px serif`;
      ctx.fillStyle = "#666";

      const charHeight = ctx.measureText("あ").width;
      const textWidth = ctx.measureText(text).width;

      const startXLeftBottom = calculateXCenterLeftBottomInMirror(
        canvas.width,
        charHeight
      );
      const startYLeftBottom = calculateYCenterLeftBottom(
        canvas.height,
        textWidth,
        charHeight
      );

      fillTextVertically(
        ctx,
        text,
        startXLeftBottom,
        startYLeftBottom,
        charHeight
      );
    }

    function buildTwitterIntentParams(text) {
      const tweetParams = new URLSearchParams();
      tweetParams.append(
        "url",
        "https://ftnext.github.io/flipped-letters-generator/"
      );
      tweetParams.append(
        "text",
        `[保存した画像またはクリップボードにコピーした画像を貼り付けてください]「${text}」を鏡文字にしました！`
      );
      tweetParams.append("hashtags", "かがみの孤城");
      return tweetParams;
    }

    function setupTweetLink(text) {
      const tweetParams = buildTwitterIntentParams(text);
      const twitterLink = document.querySelector("#twitterLink");
      if (twitterLink)
        twitterLink.href = `https://twitter.com/intent/tweet?${tweetParams}`;
    }

    drawButton.onclick = () => {
      clearCanvas();

      const sentence = sentenceInput.value;
      const fontSize = 40;

      drawTextInMirror(ctx, sentence, fontSize);
      setupTweetLink(sentence);
    };
  </script>
</body>
